<!DOCTYPE html>
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-elements/core-elements.html">
<link rel="import" href="bower_components/paper-elements/paper-elements.html">
<polymer-element name="x-flickr-shadowbox" on-down="{{shadowGestureDown}}" touch-action="pan-y" on-trackstart="{{shadowGestureStart}}" on-trackend="{{shadowGestureEnd}}" on-track="{{shadowGestureTrack}}" on-tap="{{shadowTap}}" attributes="photoModel">
  <template>
    <style>
      :host {
        display: block;
      }
      #shadowbox {
        box-sizing: border-box;
        height: 344px;        /* TODO make this an attribute */
        margin-left: 16px;
        margin-top: 8px;
        margin-right: 16px;
      }
      #touchContainer {
        height: 100%;
        -webkit-transform-style: preserve-3d;
        position: relative;
      }
      #shadowbox .front {
        backface-visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #shadowbox .back {
        position: absolute;
        top: 0;
        left: 0;
        background-color: teal;
        width: 100%;
        height: 100%;
        overflow: hidden;
        backface-visibility: hidden;
        transform: rotateY(180deg);
      }
      .header-img {
        height: 220px;
        overflow: hidden;
      }
      .header-img .img {
        width: 100%;
      }
      #description {
        margin: 8px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        height: 100%;
      }
    </style>

    <div id="shadowbox" >
      <div id="touchContainer">
        <paper-shadow z="1"></paper-shadow>
        <div class="back">
          this is the back
        </div>
        <div class="front" layout vertical>
          <div class="header-img">
            <img src="{{ photoModel.url_m }}" />
          </div>
          <h3>{{title}}</h3>
          <div id="description" class="description" flex>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
    Polymer('x-flickr-shadowbox', {
      rotation: 0,
      photoModelChanged: function(oldVal, newVal) {
        this.$.description.innerHTML = newVal.description._content;
      },
      ready: function() {
      },
      shadowTap: function(e) {
        console.log('tapped', this);
        if(this.dragging) {
          return;
        }
        if(this.rotationPlayer) {
          console.log('reversing');
          this.rotationPlayer.reverse();
          if(this.rotationPlayer.finished) {
            this.rotationPlayer.play();
            }
          return;
        }
        this.rotationPlayer = this.$.touchContainer.animate(
          [{ transform: 'rotateY(0deg);' },
           { transform: 'rotateY(180deg);' }],
          {
            duration: 500,
            fill: "both"
          }
          );
      },
      shadowGestureDown: function(e, detail, sender) {
        
      },
      shadowGestureTrack: function(e) {
        var dragOffset = e.clientX;
        this.dragPlayer.currentTime = (dragOffset / 360) * 2000;
      },
      shadowGestureStart: function(e, detail, sender) {
        console.log('beginning gesture on ', sender);
        this.dragging = true;
        var keyframes = [
          { transform: 'translateX(0)' },
          { transform: 'translateX(25%)' }
          ];
        this.dragPlayer = this.$.shadowbox.animate(keyframes,
                                                   { duration: 2000,
                                                     fill: 'both',
                                                     easing: 'ease-out'
                                                   });
        this.dragPlayer.pause();
      },
      shadowGestureEnd: function(e) {
        this.dragging = false;
      }
    });
  </script>
</polymer-element>
