<!DOCTYPE html>
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-elements/core-elements.html">
<!--

  Attributes:
    min: string value for translateX at beginning (default 0)
    max: string value for translateX at end (required)
    snapPoints: list of values to snap to. Default to none, but set to same
                values as min/max to animate to them when released
 -->
<polymer-element name="x-inertial-slider" touch-action="pan-y" on-trackstart="{{gestureStart}}" on-trackend="{{gestureEnd}}" on-track="{{gestureTrack}}" attributes="resistance touchElement useImplAnimation snapPoints snapAnimDuration min max">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="slideContainer">
      <div id="offsetContainer">
        <content></content>
      </div>
    </div>
  </template>
  <script>
    Polymer('x-inertial-slider', {
      dragDuration_: 5000,    // controls granularity of the animation
      dragPlayer_: null,
      dragBeginTimeline_: 0,
      dragBeginCoordinate_: 0,
      min: 0,
      logTag_: '\[inertial-slider\]',
      log_: function(str) {
        console.log(this.logTag_, str);
      },
      ready: function() {
        if(!this.snapPoints) {
          this.snapPoints = null;
        }
      },
      gestureStart: function(e, detail, sender) {
        this.log_('beginning slide gesture');
        // If there isn't a drag in progress, start a new animation
        if(!this.dragPlayer) {
          var keyframes = [
            { transform: 'translateX(' + this.min + ')' },
            { transform: 'translateX(' + this.max + ')' }
            ];
          var animationTiming = {
            duration: this.dragDuration_,
            fill: 'both',
            easing: 'ease-out'
          };
          this.dragPlayer = this.$.offsetContainer.animate(keyframes,
              animationTiming);
        }
        // Using either the new animation or the existing one, reset
        // where this drag has begun from. Use pageX to support events
        // outside of the target
        this.dragBeginCoordinate_ = e.pageX;
        this.dragBeginTimeline_ = this.dragPlayer.currentTime;
        this.dragPlayer.pause();
      },
      gestureEnd: function(e, detail, sender) {
        console.log('ending gesture');
        e.preventTap(); //TODO is this still needed?
        if(this.dragPlayer.currentTime != 0) {
          if(this.dragPlayer.playbackRate > 0) {
            this.dragPlayer.reverse();
            console.log('reversing');
          }
          this.dragPlayer.play();
        }
      },
      gestureTrack: function(e, detail, sender) {
        // track the touch drag along the box's predefined translate animation
        var dragOffset = e.pageX- this.dragBeginLocation;
        var timelineOffset =
          (dragOffset / window.screen.width) * this.dragDuration_;
        this.dragPlayer.currentTime = this.timelineBegin + timelineOffset;
        // clamp the values of currentTime to the valid animation range
        if(this.dragPlayer.currentTime < 0) {
          this.dragPlayer.currentTime = 0;
          }
        if(this.dragPlayer.currentTime > this.dragDuration_) {
          this.dragPlayer.currentTime = this.dragDuration_;
          }
        // (just some logging)
        if(!this.lastTrack) this.lastTrack=this.dragBeginLocation;
        console.log('tracking by',
            360*0.25*(timelineOffset - this.lastTrack)/this.dragDuration_);
        this.lastTrack = timelineOffset;
      },
    });
  </script>
</polymer-element>
